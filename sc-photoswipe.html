<link rel="import" href="../polymer/polymer.html" />
<link rel="import" href="../polymer/polymer.html" />
<link rel="import" href="../iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../iron-swipeable-container/iron-swipeable-container.html">
<link rel="import" href="icons.html">

<link rel="stylesheet" href="../photoswipe/dist/photoswipe.css">
<link rel="stylesheet" href="../photoswipe/dist/default-skin/default-skin.css">

<script src="../photoswipe/dist/photoswipe.js"></script>
<script src="../photoswipe/dist/photoswipe-ui-default.js"></script>

<dom-module id="sc-photoswipe">
  <template>
    <style>
      .preview {
        @apply(--layout-horizontal);
        @apply(--layout-wrap);
        @apply(--layout-start-justified);
        margin: 0 -5px;
        -webkit-touch-callout: none;
        -moz-user-select: none;
        -ms-user-select: none;
        -webkit-user-select: none;
        user-select: none;
      }

      .preview > div, .preview ::content > div {
        position: relative;
        @apply(--layout);
        @apply(--layout-flex);
        -ms-flex: 1 1 125px;
        -webkit-flex-basis: 125px;
        flex-basis: 125px;
        margin: 5px;
        border: 1px dotted #eee;
        min-height: 100px;
        border-radius: 2px;
        @apply(--sc-photoswipe-preview-item);
      }

      .preview > div > img, .preview ::content > div > img {
        width: 100%;
        background: white;
        @apply(--layout-self-center);

        @apply(--sc-photoswipe-preview-item-image);

        -webkit-transition: opacity 1s;
        transition: opacity 1s;
      }

      .preview > div > img.hidden, .preview ::content > div > img.hidden {
        opacity: 0;
        -webkit-transition: opacity 0s;
        transition: opacity 0s;
      }

      .preview > div > label, .preview ::content > div > label {
        @apply(--layout-fit);

        top: 1px;
        right: 1px;
        bottom: 1px;
        left: 1px;

        @apply(--layout);
        @apply(--layout-center-center);

        z-index: 1;
        visibility: hidden;
        text-align: center;
        color: var(--secondary-text-color);

        @apply(--sc-photoswipe-preview-item-label);
      }
      .preview > div > label > span {
        padding: 5px;
        border-radius: 2px;
        word-wrap: break-word;
        display: inline-block;
        max-width: 100%;
      }
      .preview > div > iron-icon {
        position: absolute;
        width: 75%;
        height: 75%;
        top: 12.5%;
        left: 12.5%;
        opacity: 0.2;
        color: var(--primary-color);
        z-index: -1;

        @apply(--sc-photoswipe-preview-item-icon);
      }
      .preview > div:hover > label {
        visibility: visible;
      }
      .preview > div:hover > label > span {
        background-color: rgba(255, 255, 255, 0.9);
      }
    </style>

    <iron-swipeable-container id="swipeable" class="preview" swipe-style="curved" disabled="[[!removeable]]">
      <content></content>
      <template is="dom-repeat" items="[[items]]">
        <div data-index$="[[index]]" on-tap="popup">
          <iron-icon icon="[[icon(item)]]"></iron-icon>
          <label>
            <span>[[item.name]]</span>
          </label>
          <img src$="[[thumbnail(item)]]" alt class$="[[className(item)]]" on-load="imageLoaded">
        </div>
      </template>
    </iron-swipeable-container>

    <div class="pswp" tabindex="-1" role="dialog" aria-hidden="true" id="pswp" hidden>
      <div class="pswp__bg"></div>
      <div class="pswp__scroll-wrap">
        <div class="pswp__container">
          <div class="pswp__item"></div>
          <div class="pswp__item"></div>
          <div class="pswp__item"></div>
        </div>
        <div class="pswp__ui pswp__ui--hidden">

          <div class="pswp__top-bar">
            <div class="pswp__counter"></div>
            <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
            <button class="pswp__button pswp__button--share" title="Share"></button>
            <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
            <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

            <div class="pswp__preloader">
              <div class="pswp__preloader__icn">
                <div class="pswp__preloader__cut">
                <div class="pswp__preloader__donut"></div>
                </div>
              </div>
            </div>
          </div>

          <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
            <div class="pswp__share-tooltip"></div>
          </div>

          <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)"></button>

          <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button>

          <div class="pswp__caption">
            <div class="pswp__caption__center"></div>
          </div>

        </div>
      </div>
    </div>
  </template>
</dom-module>

<script>
(function () {

  var cache = {};

  window.Polymer({
    is: 'sc-photoswipe',

    properties: {
      items: {
        type: Array,
        value: []
      },
      removeable: {
        type: Boolean,
        value: false
      },
      options: {
        type: Object,
        value: {
          captionEl: false,
          fullscreenEl: true,
          zoomEl: true,
          shareEl: false,
          history: false
        }
      }
    },

    observers: [
      'initialize(items.splices)'
    ],

    attached: function () {
      this.$.swipeable._onTransitionEnd = function (e) {
        var root = Polymer.dom(e).rootTarget;
        var index = root.getAttribute('data-index');

        if (!this._swipeComplete || e.propertyName !== 'opacity' || index === null) {
          return;
        }

        this.fire('remove', {
          index: parseInt(index, 10)
        });
      };
    },

    initialize: function () {
      var todo = this.items.length;
      var done = -1;
      var end = function () {
        done += 1;

        if (done >= todo) {
          this.fire('initialized');
        }
      }.bind(this);

      this.items.forEach(function (item) {
        item.src = item.src || item.url;

        if (!item.src) {
          return;
        }

        item._id = item._id || 10000 + Math.floor(Math.random() * 89999);
        if (cache[item._id]) {
          item.w = cache[item._id].w;
          item.h = cache[item._id].h;
          item.loaded = true;
          return;
        }

        var img = new Image();

        img.style.visibility = 'hidden';
        img.style.position = 'absolute';

        img.onload = function () {
          var rect = this.getBoundingClientRect();
          item.w = rect && rect.width * 10 || 100;
          item.h = rect && rect.height * 10 || 100;
          item.loaded = true;
          cache[item._id] = item;
          document.body.removeChild(img);

          end();
        };

        img.onerror = function () {
          end();
        };

        document.body.appendChild(img);
        img.src = item.src;
      });

      end();
    },

    popup: function (e) {
      var target;
      var index = 0;

      if (e && e.preventDefault) {
        target = Polymer.dom(e).rootTarget;
        while (target && target.tagName !== 'DIV') {
          target = target.parentNode;
        }

        e.preventDefault();
        e.cancelBubble = true;
      }

      if (!this.items || !this.items.length) {
        return;
      }

      if (typeof e === 'number') {
        index = e;
      }
      else if (target) {
        index = parseInt(target.getAttribute('data-index'), 10) || 0;
      }

      var item = this.items[index];

      if (!item) {
        return;
      }

      var items = this.items.filter(function (item) {
        return /image|jpg|jpeg|png/i.test(item.type);
      });

      this.options.index = items.indexOf(item);

      if (!items.length || this.options.index < 0) {
        if (window.viewLink) {
          return window.viewLink(item.src);
        }

        return window.open(item.src);
      }

      if (!this._pswp) {
        this._pswp = this.$.pswp;
        document.body.appendChild(this._pswp);
      }

      var ui = window.PhotoSwipeUI_Default;

      this.photoswipe = new window.PhotoSwipe(this._pswp, ui, items, this.options);
      this._pswp.removeAttribute('hidden');

      this._close = this._close || this.close.bind(this);

      document.addEventListener('backbutton', this._close, false);
      this.photoswipe.init();
    },

    close: function () {
      document.removeEventListener('backbutton', this._close, false);

      if (this.photoswipe) {
        this.photoswipe.close();
      }
    },

    thumbnail: function (item) {
      return item.thumbnail || item.src || this.dummy;
    },

    icon: function (item) {
      if (/pdf/i.test(item && item.type)) {
        return 'sc-photoswipe:picture-as-pdf';
      }
      else if (/video/i.test(item && item.type)) {
        return 'sc-photoswipe:movie-creation';
      }
      else if (/image/i.test(item && item.type)) {
        return 'sc-photoswipe:photo';
      }
      else if (/audio/i.test(item && item.type)) {
        return 'sc-photoswipe:audiotrack';
      }

      return 'sc-photoswipe:insert-drive-file';
    },

    className: function (item) {
      return item.loaded ? '' : 'hidden';
    },

    imageLoaded: function (e) {
      var root = Polymer.dom(e).rootTarget;
      root.parentNode.removeAttribute('style');
      root.classList.remove('hidden');
    }
  });

})();
</script>
