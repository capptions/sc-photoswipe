<link rel="import" href="../polymer/polymer.html" />
<link rel="import" href="../polymer/polymer.html" />
<link rel="import" href="../iron-flex-layout/iron-flex-layout.html">

<link rel="stylesheet" href="../photoswipe/dist/photoswipe.css">
<link rel="stylesheet" href="../photoswipe/dist/default-skin/default-skin.css">

<script src="../photoswipe/dist/photoswipe.js"></script>
<script src="../photoswipe/dist/photoswipe-ui-default.js"></script>

<dom-module id="sc-photoswipe">
  <template>
    <style>
      .preview {
        @apply(--layout-horizontal);
        @apply(--layout-wrap);
        @apply(--layout-start-justified);
        margin: 0 -5px;
      }

      .preview > div, .preview ::content > div {
        position: relative;
        @apply(--layout);
        @apply(--layout-flex);
        -ms-flex: 1 1 125px;
        -webkit-flex-basis: 125px;
        flex-basis: 125px;
        margin: 5px;
        border: 1px dotted #eee;
        min-height: 100px;
        min-width: 125px;
        border-radius: 2px;
        @apply(--sc-photoswipe-preview-item);
      }

      .preview > div > img, .preview ::content > div > img {
        width: 100%;
        background: white;
        @apply(--layout-self-center);

        @apply(--sc-photoswipe-preview-item-image);
      }

      .preview > div > label, .preview ::content > div > label {
        @apply(--layout-fit);
        @apply(--layout);
        @apply(--layout-center-center);

        z-index: -1;
        text-align: center;
        color: var(--secondary-text-color);

        @apply(--sc-photoswipe-preview-item-label);
      }
      .preview > div > label > span {
        padding: 5px;
        border-radius: 2px;
      }
      .preview > div:hover > label {
        z-index: 1;
      }
      .preview > div:hover > label > span {
        background-color: rgba(255, 255, 255, 0.9);
      }

      .preview > div > paper-icon-button {
        visibility: hidden;
        position: absolute;
        top: 0;
        right: 0;
        z-index: 2;
        background: white;
        color: var(--primary-color);
      }
      .preview > div:hover > paper-icon-button {
        visibility: visible;
      }
    </style>

    <div class="preview">
      <content></content>
      <template is="dom-repeat" items="[[items]]">
        <div data-index$="[[index]]" on-tap="popup">
          <paper-icon-button icon="remove-circle-outline" on-tap="remove"></paper-icon-button>
          <label>
            <span>[[item.name]]</span>
          </label>
          <img src="[[thumbnail(item)]]" alt hidden on-load="imageLoaded" on-error="imageError">
        </div>
      </template>
    </div>

    <div class="pswp" tabindex="-1" role="dialog" aria-hidden="true" id="pswp" hidden>
      <div class="pswp__bg"></div>
      <div class="pswp__scroll-wrap">
        <div class="pswp__container">
          <div class="pswp__item"></div>
          <div class="pswp__item"></div>
          <div class="pswp__item"></div>
        </div>
        <div class="pswp__ui pswp__ui--hidden">

          <div class="pswp__top-bar">
            <div class="pswp__counter"></div>
            <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
            <button class="pswp__button pswp__button--share" title="Share"></button>
            <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
            <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

            <div class="pswp__preloader">
              <div class="pswp__preloader__icn">
                <div class="pswp__preloader__cut">
                <div class="pswp__preloader__donut"></div>
                </div>
              </div>
            </div>
          </div>

          <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
            <div class="pswp__share-tooltip"></div>
          </div>

          <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)"></button>

          <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button>

          <div class="pswp__caption">
            <div class="pswp__caption__center"></div>
          </div>

        </div>
      </div>
    </div>
  </template>
</dom-module>

<script>
(function () {

  window.Polymer({
    is: 'sc-photoswipe',

    properties: {
      items: {
        type: Array,
        value: []
      },
      dummy: {
        type: String,
        value: 'data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7'
      },
      removeable: {
        type: Boolean,
        value: false
      },
      options: {
        type: Object,
        value: {
          captionEl: false,
          fullscreenEl: true,
          zoomEl: true,
          shareEl: false,
          history: false
        }
      }
    },

    observers: [
      'initialize(items.splices)'
    ],

    initialize: function () {
      this.items.forEach(function (item) {
        if (!item.src) {
          return;
        }

        var img = new Image();
        img.style.visibility = 'hidden';
        img.style.position = 'absolute';
        img.onload = function () {
          var rect = this.getBoundingClientRect();
          item.w = rect && rect.width * 10 || 100;
          item.h = rect && rect.height * 10 || 100;
          document.body.removeChild(img);
        };
        img.onerror = function () {

        };
        document.body.appendChild(img);
        img.src = item.src;
      });
    },

    popup: function (e) {
      e.preventDefault();
      e.cancelBubble = true;

      if (!this.items || !this.items.length) {
        return;
      }

      var el = e.detail.sourceEvent.target;
      while (el.tagName !== 'DIV') {
        el = el.parentNode;
      }

      var index = parseInt(el.getAttribute('data-index'), 10);
      var item = this.items[index];

      var items = this.items.filter(function (item) {
        return /image|jpg|jpeg|png/i.test(item.type);
      });

      this.options.index = items.indexOf(item);

      if (!items.length || this.options.index < 0) {
        if (window.viewImage) {
          return window.viewImage(item.src);
        }

        return window.open(item.src);
      }

      if (!this._pswp) {
        this._pswp = this.$.pswp;
        document.body.appendChild(this._pswp);
      }

      var ui = window.PhotoSwipeUI_Default;

      this.photoswipe = new window.PhotoSwipe(this._pswp, ui, items, this.options);
      this._pswp.removeAttribute('hidden');
      this.photoswipe.init();
    },

    remove: function (e) {
      e.preventDefault();
      e.cancelBubble = true;
      this.fire('remove', e.model.__data__.item);
    },

    thumbnail: function (item) {
      return item.thumbnail || item.src || this.dummy;
    },

    imageLoaded: function (e) {
      Polymer.dom(e).rootTarget.removeAttribute('hidden');
    },

    imageError: function (e) {
      Polymer.dom(e).rootTarget.src = this.dummy;
    }
  });

})();
</script>
